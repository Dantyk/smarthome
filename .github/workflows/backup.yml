name: Daily Backup

on:
  schedule:
    # Every day at 3:00 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch: # Allow manual trigger

env:
  BACKUP_RETENTION_DAYS: 30
  S3_BUCKET: ${{ secrets.BACKUP_S3_BUCKET }}

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pyyaml
      
      - name: Create backup
        id: backup
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          ./scripts/backup.sh
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "archive=backups/smarthome_backup_${TIMESTAMP}.tar.gz" >> $GITHUB_OUTPUT
      
      - name: Verify backup
        run: |
          ./scripts/verify-backup.sh ${{ steps.backup.outputs.archive }}
      
      - name: Upload to GitHub Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: smarthome-backup-${{ steps.backup.outputs.timestamp }}
          path: ${{ steps.backup.outputs.archive }}
          retention-days: ${{ env.BACKUP_RETENTION_DAYS }}
      
      - name: Upload to S3 (if configured)
        if: env.S3_BUCKET != ''
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          aws s3 cp ${{ steps.backup.outputs.archive }} \
            s3://${S3_BUCKET}/smarthome/backups/ \
            --storage-class STANDARD_IA
      
      - name: Cleanup old local backups
        run: |
          find backups/ -name "smarthome_backup_*.tar.gz" -mtime +${{ env.BACKUP_RETENTION_DAYS }} -delete
          echo "Deleted backups older than ${{ env.BACKUP_RETENTION_DAYS }} days"
      
      - name: Send notification on failure
        if: failure()
        run: |
          echo "Backup failed! Check workflow logs."
          # Add notification logic here (e.g., Discord webhook, email)
