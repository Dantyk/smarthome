services:
  mosquitto:
    image: eclipse-mosquitto:2
    restart: unless-stopped
    ports: ["1883:1883","9001:9001"]
    volumes:
      - ./config/mosquitto:/mosquitto/config:ro
      - mosquitto_data:/mosquitto/data
  nodered:
    image: nodered/node-red:latest
    restart: unless-stopped
    ports: ["1880:1880"]
    depends_on: [mosquitto]
    environment:
      - TZ=Europe/Bratislava
      - BAIKAL_BASE_URL=http://baikal:80/dav.php
      - BAIKAL_USER=smarthome
      - BAIKAL_PASS=smarthome
      - BAIKAL_CAL_ID=default
      - GOOGLE_CALENDAR_API_KEY=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_CALENDAR_ID=${GOOGLE_CLIENT_ID}
      - OPENWEATHER_API_KEY=${OPENWEATHER_API_KEY}
    volumes:
      - ../flows/nodered:/data
      - ./config/nodered/settings.js:/data/settings.js:ro
      - ../config:/config:ro
  baikal:
    image: ckulka/baikal:0.10.1-apache
    restart: unless-stopped
    ports: ["8800:80"]
    volumes:
      - baikal_data:/var/www/baikal
  
  baikal-init:
    image: curlimages/curl:latest
    depends_on:
      - baikal
    environment:
      - BAIKAL_URL=http://baikal:80
      - BAIKAL_USER=smarthome
      - BAIKAL_PASS=smarthome
      - BAIKAL_CALENDAR_NAME=default
    volumes:
      - ./scripts/baikal-init.sh:/scripts/baikal-init.sh:ro
    entrypoint: ["/bin/sh", "/scripts/baikal-init.sh"]
    restart: "no"
  
  apprise:
    image: caronc/apprise:latest
    restart: unless-stopped
    ports: ["8000:8000"]
    profiles: [notify]
    environment:
      - APPRISE_STATELESS_URLS=pover://${PUSHOVER_USER}@${PUSHOVER_TOKEN}
    volumes:
      - apprise_config:/config
  
  zwavejsui:
    image: zwavejs/zwave-js-ui:latest
    restart: unless-stopped
    ports: ["8091:8091"]
    devices: [ "/dev/ttyACM0:/dev/ttyACM0" ]   # uprav podÄ¾a RPi
    environment: [ "TZ=Europe/Bratislava" ]
    volumes:
      - zwave_data:/usr/src/app/store
  ui:
    image: compose-ui
    build:
      context: ../ui/smarthome-ui
      dockerfile: Dockerfile
    restart: unless-stopped
    ports: ["8088:3000"]
    depends_on: [mosquitto]
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_MQTT_BROKER=ws://192.168.1.178:9001
      - NEXT_PUBLIC_API_BASE=http://192.168.1.178:1880
      - NEXT_PUBLIC_TZ=Europe/Bratislava
      - NEXT_PUBLIC_LOCATION=Bratislava, SK
volumes:
  mosquitto_data:
  baikal_data:
  apprise_config:
  zwave_data:
