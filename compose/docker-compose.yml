services:
  mosquitto:
    image: eclipse-mosquitto:2
    restart: unless-stopped
    ports: ["1883:1883","9001:9001"]
    volumes:
      - ./config/mosquitto:/mosquitto/config:ro
      - mosquitto_data:/mosquitto/data
  nodered:
    image: nodered/node-red:latest
    restart: unless-stopped
    ports: ["1880:1880"]
    depends_on: [mosquitto]
    environment:
      - TZ=Europe/Bratislava
      - BAIKAL_BASE_URL=http://baikal:80/dav.php
      - BAIKAL_USER=smarthome
      - BAIKAL_PASS=smarthome
      - BAIKAL_CAL_ID=default
      - GOOGLE_CALENDAR_API_KEY=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_CALENDAR_ID=${GOOGLE_CLIENT_ID}
      - OPENWEATHER_API_KEY=${OPENWEATHER_API_KEY}
    volumes:
      - ../flows/nodered:/data
      - ./config/nodered/settings.js:/data/settings.js:ro
      - ../config:/config:ro
  baikal:
    image: ckulka/baikal:0.10.1-apache
    restart: unless-stopped
    ports: ["8800:80"]
    volumes:
      - baikal_data:/var/www/baikal
  
  baikal-init:
    image: curlimages/curl:latest
    depends_on:
      - baikal
    environment:
      - BAIKAL_URL=http://baikal:80
      - BAIKAL_USER=smarthome
      - BAIKAL_PASS=smarthome
      - BAIKAL_CALENDAR_NAME=default
    volumes:
      - ./scripts/baikal-init.sh:/scripts/baikal-init.sh:ro
    entrypoint: ["/bin/sh", "/scripts/baikal-init.sh"]
    restart: "no"
  
  apprise:
    image: caronc/apprise:latest
    restart: unless-stopped
    ports: ["8000:8000"]
    profiles: [notify]
    environment:
      - APPRISE_STATELESS_URLS=pover://${PUSHOVER_USER}@${PUSHOVER_TOKEN}
    volumes:
      - apprise_config:/config
  
  zwavejsui:
    image: zwavejs/zwave-js-ui:latest
    restart: "no"  # Nereštartuj ak zariadenie neexistuje
    ports: ["${ZWAVE_PORT:-8091}:8091"]
    devices: [ "${ZWAVE_DEVICE}:/dev/ttyACM0" ]
    environment: [ "TZ=Europe/Bratislava" ]
    volumes:
      - zwave_data:/usr/src/app/store
    profiles: [zwave]

  zigbee2mqtt:
    image: koenkk/zigbee2mqtt:latest
    restart: "no"  # Nereštartuj ak zariadenie neexistuje
    ports: ["${Z2M_PORT:-8090}:8080"]
    devices: [ "${ZIGBEE_DEVICE}:/dev/ttyACM0" ]
    profiles: [zigbee]
    depends_on: [mosquitto]
    environment:
      - TZ=Europe/Bratislava
    volumes:
      - ./config/zigbee2mqtt:/app/data
      - /run/udev:/run/udev:ro

  influxdb:
    image: influxdb:2.7-alpine
    restart: unless-stopped
    ports: ["${INFLUX_PORT:-8086}:8086"]
    profiles: [metrics]
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUX_USER:-admin}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUX_PASSWORD:-admin123}
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUX_ORG:-Home}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUX_BUCKET:-smarthome}
      - DOCKER_INFLUXDB_INIT_RETENTION=30d
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUX_TOKEN:-changeme}
    volumes:
      - influxdb_data:/var/lib/influxdb2

  grafana:
    image: grafana/grafana:latest
    restart: unless-stopped
    ports: ["${GRAFANA_PORT:-3000}:3000"]
    profiles: [metrics]
    depends_on: [influxdb]
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin123}
      - GF_INSTALL_PLUGINS=
    volumes:
      - grafana_data:/var/lib/grafana

  ui:
    image: compose-ui
    build:
      context: ../ui/smarthome-ui
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_MQTT_BROKER: ws://192.168.1.178:9001
        NEXT_PUBLIC_API_BASE: http://192.168.1.178:1880
        NEXT_PUBLIC_TZ: Europe/Bratislava
        NEXT_PUBLIC_LOCATION: Bratislava, SK
    restart: unless-stopped
    ports: ["8088:3000"]
    depends_on: [mosquitto]
    environment:
      - NODE_ENV=production
volumes:
  mosquitto_data:
  baikal_data:
  apprise_config:
  zwave_data:
  influxdb_data:
  grafana_data:
