services:
  mosquitto:
    image: eclipse-mosquitto:2
    restart: unless-stopped
    ports: ["1883:1883","9001:9001"]
    volumes:
      - ./config/mosquitto:/mosquitto/config:ro
      - mosquitto_data:/mosquitto/data
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-t", "$$SYS/#", "-C", "1", "-W", "3"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
  nodered:
    image: nodered/node-red:latest
    restart: unless-stopped
    ports: ["1880:1880"]
    depends_on:
      mosquitto:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - TZ=Europe/Bratislava
      - BAIKAL_BASE_URL=http://baikal:80/dav.php
      - BAIKAL_USER=smarthome
      - BAIKAL_PASS=smarthome
      - BAIKAL_CAL_ID=default
      - GOOGLE_CALENDAR_API_KEY=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_CALENDAR_ID=${GOOGLE_CLIENT_ID}
      - OPENWEATHER_API_KEY=${OPENWEATHER_API_KEY}
      - PUSHOVER_USER=${PUSHOVER_USER}
      - PUSHOVER_TOKEN=${PUSHOVER_TOKEN}
      - LOG_LEVEL=info
      - MQTT_USER=${MQTT_USER:-nodered}
      - MQTT_PASSWORD=${MQTT_PASSWORD:-}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    volumes:
      - ../flows/nodered:/data
      - ./config/nodered/settings.js:/data/settings.js:ro
      - ./scripts/nodered-init.sh:/init/nodered-init.sh:ro
      - ../config:/config:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:1880"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    stop_grace_period: 30s
  
  baikal:
    image: ckulka/baikal:0.10.1-apache
    restart: unless-stopped
    ports: ["8800:80"]
    volumes:
      - baikal_data:/var/www/baikal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/dav.php"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
  
  baikal-init:
    image: curlimages/curl:latest
    depends_on:
      - baikal
    environment:
      - BAIKAL_URL=http://baikal:80
      - BAIKAL_USER=smarthome
      - BAIKAL_PASS=smarthome
      - BAIKAL_CALENDAR_NAME=default
    volumes:
      - ./scripts/baikal-init.sh:/scripts/baikal-init.sh:ro
    entrypoint: ["/bin/sh", "/scripts/baikal-init.sh"]
    restart: "no"
  
  apprise:
    image: caronc/apprise:latest
    restart: unless-stopped
    ports: ["8000:8000"]
    profiles: [notify]
    environment:
      - APPRISE_STATELESS_URLS=pover://${PUSHOVER_USER}@${PUSHOVER_TOKEN}
    volumes:
      - apprise_config:/config
  
  zwavejsui:
    image: zwavejs/zwave-js-ui:latest
    restart: unless-stopped
    ports: ["${ZWAVE_PORT:-8091}:8091"]
    privileged: true  # Prístup k /dev zariadeniam
    environment:
      - TZ=Europe/Bratislava
      - ZWAVEJS_EXTERNAL_CONFIG=/usr/src/app/store/.config-db
    volumes:
      - zwave_data:/usr/src/app/store
      - /dev:/dev:ro  # Read-only prístup k zariadeniam
    profiles: [zwave]

  zigbee2mqtt:
    image: koenkk/zigbee2mqtt:latest
    restart: unless-stopped
    ports: ["${Z2M_PORT:-8090}:8080"]
    privileged: true  # Prístup k /dev zariadeniam
    profiles: [zigbee]
    depends_on: [mosquitto]
    environment:
      - TZ=Europe/Bratislava
    volumes:
      - ./config/zigbee2mqtt:/app/data
      - /run/udev:/run/udev:ro
      - /dev:/dev:ro  # Read-only prístup k zariadeniam

  influxdb:
    image: influxdb:2.7-alpine
    restart: unless-stopped
    ports: ["${INFLUX_PORT:-8086}:8086"]
    profiles: [metrics]
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUX_USER:-admin}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUX_PASSWORD:-admin123}
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUX_ORG:-Home}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUX_BUCKET:-smarthome}
      - DOCKER_INFLUXDB_INIT_RETENTION=30d
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUX_TOKEN:-changeme}
    volumes:
      - influxdb_data:/var/lib/influxdb2

  grafana:
    image: grafana/grafana:latest
    restart: unless-stopped
    ports: ["${GRAFANA_PORT:-3000}:3000"]
    profiles: [metrics]
    depends_on: [influxdb]
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin123}
      - GF_INSTALL_PLUGINS=
      - INFLUX_ORG=${INFLUX_ORG:-Home}
      - INFLUX_BUCKET=${INFLUX_BUCKET:-smarthome}
      - INFLUX_TOKEN=${INFLUX_TOKEN}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning:ro

  ui:
    image: compose-ui
    build:
      context: ../ui/smarthome-ui
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_TZ: Europe/Bratislava
        NEXT_PUBLIC_LOCATION: Bratislava, SK
    restart: unless-stopped
    ports: ["8088:3000"]
    depends_on:
      mosquitto:
        condition: service_healthy
    environment:
      - NODE_ENV=production
      - MQTT_BROKER_URL=ws://mosquitto:9001
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  jaeger:
    image: jaegertracing/all-in-one:latest
    restart: unless-stopped
    ports:
      - "16686:16686"    # Jaeger UI
      - "14268:14268"    # Jaeger collector HTTP
      - "14250:14250"    # Jaeger gRPC
      - "6831:6831/udp"  # Jaeger compact thrift
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - LOG_LEVEL=info
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:14269/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  prometheus:
    image: prom/prometheus:latest
    restart: unless-stopped
    ports: ["9090:9090"]
    volumes:
      - ./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./config/prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
  
  alertmanager:
    image: prom/alertmanager:latest
    restart: unless-stopped
    ports: ["9093:9093"]
    volumes:
      - ./config/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager_data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    environment:
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL:-}
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9093/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports: ["6379:6379"]
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  mosquitto_data:
  baikal_data:
  apprise_config:
  zwave_data:
  influxdb_data:
  grafana_data:
  prometheus_data:
  alertmanager_data:
  redis_data:
